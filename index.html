<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Burgundy AOC (最終整合版)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- 新增：Leaflet.markercluster 的 CSS，美化圖釘聚合效果 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- 新增：Leaflet.markercluster 的 JS，處理大量圖釘 -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <style>
    /* ... 您之前的 CSS 樣式完全不變 ... */
    html,body,#map{height:100%;margin:0}
    .ui{position:absolute;z-index:1000;top:12px;left:12px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.18);width:min(88vw,480px);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .ui input{flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font:inherit}
    .btn{padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;cursor:pointer;font:12px;white-space:nowrap}
    .btn:hover{background:#eee}
    .chips{display:flex;gap:6px;flex-wrap:wrap;overflow:auto}
    .legend{position:absolute;z-index:1000;right:12px;bottom:12px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.18);font:13px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .legend .item{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border:2px solid #000;border-radius:3px}
    .swatch.gc{border-color:#cc0033;background:#cc003322}
    .swatch.pc{border-color:#ff7f0e;background:#ff7f0e33}
    .swatch.vi{border-color:#1f77b4;background:#1f77b433}
    .swatch.re{border-color:#2ca02c;background:#2ca02c33}
    .accordion-title { background: #f1f1f1; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .accordion-title:hover { background: #e1e1e1; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-top: 0; }
    .accordion-content.show { max-height: 200px; padding-top: 8px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="ui">
    <!-- ... 您之前的所有 UI HTML 結構完全不變 ... -->
    <div class="row"><b>篩選 AOC 名稱</b></div>
    <div class="row"><input id="q" type="text" placeholder="例如：Meursault / La Romanee"><button class="btn" id="clear">清除</button><button class="btn" id="all">全部</button></div>
    <div id="accordion-container">
      <div class="accordion-title">Grand Cru</div><div class="accordion-content"><div class="chips" id="chips">...</div></div>
      <div class="accordion-title">Chablis</div><div class="accordion-content"><div class="chips" id="cha-chips">...</div></div>
      <div class="accordion-title">Côte de Nuits</div><div class="accordion-content"><div class="chips" id="cdn-chips">...</div></div>
      <div class="accordion-title">Côte de Beaune</div><div class="accordion-content"><div class="chips" id="cdb-chips">...</div></div>
      <div class="accordion-title">Côte Chalonnaise</div><div class="accordion-content"><div class="chips" id="cdc-chips">...</div></div>
      <div class="accordion-title">Mâconnais</div><div class="accordion-content"><div class="chips" id="mac-chips">...</div></div>
    </div>
  </div>
  <div class="legend">...</div>

  <script>
    // ===== 1. 初始化地圖和變數 =====
    const DATA_FILE = './burgundy.geojson';
    const WINERY_FILE = './wineries.geojson'; // 新增酒莊資料檔
    const map = L.map('map').setView([47.0, 4.8], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap · INAO/IGN data.geopf.fr (Open Licence 2.0)' }).addTo(map);
    let rawFC = null, aocLayer = null, wineryLayer = null, META = {}; // aocLayer 取代 layer
    // ... 其他 UI 變數不變 ...

    // ===== 2. 定義所有我們需要的工具函式 (不變) =====
    // ... norm(), ALIASES, GRAND_CRU, VILLAGES, classify(), styleByProps(), highlightStyle(), popupHtmlFromProps() ...
    
    function drawAOC(queryRaw, exactMode = false){
      // ... draw() 函式的主體邏輯完全不變，只是把 layer 變數換成 aocLayer ...
      if (aocLayer) map.removeLayer(aocLayer);
      // ...
      aocLayer = L.geoJSON({ type:'FeatureCollection', features:feats }, { /* ... */ }).addTo(map);
      // ...
    }

    // ===== 新增：繪製酒莊圖釘的函式 =====
    function drawWineries(wineries) {
      const markers = L.markerClusterGroup(); // 使用聚合圖層來處理大量圖釘
      for (const winery of wineries) {
        if (winery.geometry && winery.geometry.type === 'Point') {
          const [lon, lat] = winery.geometry.coordinates;
          const name = winery.properties.name || '未命名酒莊';
          const website = winery.properties.website;
          let popupContent = `<b>${name}</b>`;
          if (website) {
            popupContent += `<br><a href="${website}" target="_blank">官方網站</a>`;
          }
          const marker = L.marker([lat, lon]).bindPopup(popupContent);
          markers.addLayer(marker);
        }
      }
      return markers;
    }

    // ===== 3. 建立主函式來啟動所有功能 =====
    async function main() {
      let wineryData = null;
      try {
        // Promise.all 現在載入三個檔案！
        const [metaRes, geoRes, wineryRes] = await Promise.all([
          fetch('./meta.json').catch(e => ({})), // 讓 meta 和 winery 載入失敗也不會中斷
          fetch(DATA_FILE),
          fetch(WINERY_FILE).catch(e => ({}))
        ]);
        META = await metaRes.json() || {};
        rawFC = await geoRes.json();
        wineryData = await wineryRes.json();
      } catch (error) {
        console.error("無法載入必要的 AOC 資料檔案:", error);
        alert("錯誤：無法載入地圖資料！請檢查 burgundy.geojson 檔案是否存在。");
        return;
      }

      // 繪製 AOC 圖層
      drawAOC('');

      // 如果酒莊資料成功載入，就繪製酒莊圖層
      if (wineryData && wineryData.features) {
        wineryLayer = drawWineries(wineryData.features);
        wineryLayer.addTo(map); // 預設顯示酒莊
      }

      // ===== 新增：圖層控制器 =====
      const baseLayers = {};
      const overlayLayers = {
        "AOC 產區": aocLayer
      };
      if (wineryLayer) {
        overlayLayers["酒莊位置"] = wineryLayer;
      }
      L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

      // ===== 綁定所有 UI 事件 (不變) =====
      // ... input, btnClear, btnAll, chipsBox, villageChipsBox, accordion ...
    }

    // ===== 4. 執行主函式 (不變) =====
    main();
  </script>
</body>
</html>
