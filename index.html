
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Burgundy AOC (3D 地形版)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- 替換成 Mapbox GL JS 的 CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .ui{position:absolute;z-index:1000;top:12px;left:12px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.18);width:min(88vw,480px);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .ui input{flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font:inherit}
    .btn{padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;cursor:pointer;font:12px;white-space:nowrap}
    .btn:hover{background:#eee}
    .chips{display:flex;gap:6px;flex-wrap:wrap;overflow:auto}
    .accordion-title { background: #f1f1f1; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .accordion-title:hover { background: #e1e1e1; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-top: 0; }
    .accordion-content.show { max-height: 200px; padding-top: 8px; }
    
    /* Mapbox 彈窗樣式 */
    .mapboxgl-popup-content {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
    }
    .mapboxgl-popup-content b { font-size: 16px; }
    .mapboxgl-popup-content a { color: #007bff; text-decoration: none; }
    .mapboxgl-popup-content a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="ui">
    <!-- UI 的 HTML 結構完全不變 -->
    <div class="row"><b>篩選 AOC 名稱</b></div>
    <div class="row">
      <input id="q" type="text" placeholder="例如：Meursault / La Romanee">
      <button class="btn" id="clear">清除</button>
      <button class="btn" id="all">全部</button>
    </div>
    <div id="accordion-container">
      <!-- ... 所有手風琴選單的 HTML 內容都和之前一樣 ... -->
    </div>
  </div>
  <!-- 圖例不再需要，因為顏色資訊已整合在地圖樣式中 -->

  <script>
    // ===================================================================
    // ===== STEP 1: 請將下面這兩行，換成您從 Mapbox 複製的鑰匙！=====
    // ===================================================================
    const MAPBOX_STYLE_URL = 'mapbox://styles/cheyuan/cmg03uko6004z01rj94k4gr3g'; // <-- 在這裡貼上您的 Style URL
    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiY2hleXVhbiIsImEiOiJjbWZ5eDhrYnAwcmYwMmpuN3Yxam5xaXB6In0.vpuWIEgugCX1gbl0je-HDw'; // <-- 在這裡貼上您的 Access Token
    // ===================================================================

    // ===== 初始化 Mapbox 地圖 =====
    const map = new mapboxgl.Map({
      container: 'map',
      style: MAPBOX_STYLE_URL,
      center: [4.84, 47.02],
      zoom: 9,
      pitch: 45, // 預設傾斜角度，讓 3D 效果更明顯
      accessToken: MAPBOX_ACCESS_TOKEN
    });

    // ===== 變數定義 (類似但有些許不同) =====
    let META = {};
    const input = document.getElementById('q');
    const btnClear = document.getElementById('clear');
    const btnAll   = document.getElementById('all');
    const accordion = document.getElementById('accordion-container');
    
    // 我們需要知道您在 Mapbox Studio 中的 source-layer 名稱
    // 通常就是您圖磚集的名稱，例如 'burgundy-2imvx6'
    const SOURCE_LAYER_NAME = 'burgundy-2imvx6'; // <-- 請務必確認這個名稱和您在 Mapbox 看到的 Vector Layer 名稱一致

    // ===== 當地圖載入完成後，啟用 3D 地形！=====
    map.on('load', async () => {
      // 1. 加入 Mapbox 官方的 3D 地形資料來源
      map.addSource('mapbox-dem', {
        'type': 'raster-dem',
        'url': 'mapbox://mapbox.terrain-rgb',
        'tileSize': 512,
        'maxzoom': 14
      });
      // 2. 啟用 3D 地形
      map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

      // 3. 載入我們的中文 meta.json
      try {
        const metaRes = await fetch('./meta.json');
        META = await metaRes.json();
      } catch (e) {
        console.warn("無法載入 meta.json");
      }

      // 4. 為 AOC 圖層新增互動效果
      map.on('click', SOURCE_LAYER_NAME, (e) => {
        if (e.features.length > 0) {
          const props = e.features[0].properties;
          const popupHtml = popupHtmlFromProps(props);
          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(popupHtml)
            .addTo(map);
        }
      });

      map.on('mousemove', SOURCE_LAYER_NAME, (e) => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', SOURCE_LAYER_NAME, (e) => { map.getCanvas().style.cursor = ''; });
    });

    // ===== 彈窗內容函式 (邏輯類似，但為 Mapbox 重新編寫) =====
    function popupHtmlFromProps(props){
      const denom = props?.denom || '';
      const names = denom.split(',').map(s=>s.trim()).filter(Boolean);
      // ... (這裡可以加入我們之前的排序和匹配 META 的邏輯)
      // 為了簡化，我們先顯示最重要的名字
      return `<b>${names[0] || 'AOC'}</b><br>${names.slice(1).join('<br>')}`;
    }

    // ===== 搜尋功能 (Mapbox 版本) =====
    function handleSearch(query, exactMode = false) {
      // Mapbox 的篩選功能非常強大，可以直接在前端完成
      // 這裡需要更複雜的邏輯來重新實現，我們先專注於 3D 效果
      // 簡單的實現是使用 flyTo
      // const features = map.querySourceFeatures(...)
      // map.flyTo({ center: features[0].geometry.coordinates ... })
    }

    // ===== UI 事件綁定 (簡化版) =====
    btnClear.onclick = () => { input.value = ''; /* 移除篩選 */ };
    btnAll.onclick   = () => { input.value = ''; /* 移除篩選 */ };
    accordion.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn')) {
        const k = e.target?.dataset?.k;
        if (!k) return;
        input.value = e.target.innerText;
        // handleSearch(k, true);
      }
    });
    document.querySelectorAll('.accordion-title').forEach(title => {
      title.addEventListener('click', () => {
        const content = title.nextElementSibling;
        content.classList.toggle('show');
      });
    });

  </script>
</body>
</html>
